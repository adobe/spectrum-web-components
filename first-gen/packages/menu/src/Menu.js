"use strict";var v=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var o=(p,c,e,s)=>{for(var t=s>1?void 0:s?I(c,e):c,i=p.length-1,n;i>=0;i--)(n=p[i])&&(t=(s?n(c,e,t):n(t))||t);return s&&t&&v(c,e,t),t};import{html as b,SizedMixin as g,SpectrumElement as f}from"@spectrum-web-components/base";import{property as u,query as E}from"@spectrum-web-components/base/src/decorators.js";import S from"./menu.css.js";import{RovingTabindexController as y}from"@spectrum-web-components/reactive-controllers/src/RovingTabindex.js";export class Menu extends g(f,{noDefaultSize:!0}){constructor(){super();this.label="";this.ignore=!1;this.value="";this.valueSeparator=",";this._selected=[];this.selectedItems=[];this.childItemSet=new Set;this.focusedItemIndex=0;this.focusInItemIndex=0;this.shouldSupportDragAndSelect=!1;this.selectedItemsMap=new Map;this.pointerUpTarget=null;this.descendentOverlays=new Map;this.handleSubmenuClosed=e=>{e.stopPropagation(),e.composedPath()[0].dispatchEvent(new Event("sp-menu-submenu-closed",{bubbles:!0,composed:!0}))};this.handleSubmenuOpened=e=>{e.stopPropagation(),e.composedPath()[0].dispatchEvent(new Event("sp-menu-submenu-opened",{bubbles:!0,composed:!0})),e.composedPath().find(i=>this.childItemSet.has(i))};this._hasUpdatedSelectedItemIndex=!1;this._willUpdateItems=!1;this.cacheUpdated=Promise.resolve();this.resolveCacheUpdated=()=>{};!this.rovingTabindexController&&this.controlsRovingTabindex&&(this.rovingTabindexController=new y(this,{direction:"vertical",focusInIndex:e=>{let s=-1;const t=e==null?void 0:e.findIndex((i,n)=>(!e[s]&&!i.disabled&&(s=n),i.selected&&!i.disabled));return e&&t&&e[t]?t:s},elements:()=>this.childItems,isFocusableElement:this.isFocusableElement.bind(this),hostDelegatesFocus:!0})),this.addEventListener("sp-menu-item-added-or-updated",this.onSelectableItemAddedOrUpdated),this.addEventListener("sp-menu-item-added-or-updated",this.onFocusableItemAddedOrUpdated,{capture:!0}),this.addEventListener("click",this.handleClick),this.addEventListener("touchend",this.handlePointerup),this.addEventListener("focusout",this.handleFocusout),this.addEventListener("sp-menu-item-keydown",this.handleKeydown),this.addEventListener("pointerup",this.handlePointerup),this.addEventListener("sp-opened",this.handleSubmenuOpened),this.addEventListener("sp-closed",this.handleSubmenuClosed)}static get styles(){return[S]}get isSubmenu(){return this.slot==="submenu"}get selected(){return this.selects?this._selected:[]}set selected(e){if(e===this.selected)return;const s=this.selected;this._selected=e,this.selectedItems=[],this.selectedItemsMap.clear(),this.childItems.forEach(t=>{this===t.menuData.selectionRoot&&(t.selected=this.selected.includes(t.value),t.selected&&(this.selectedItems.push(t),this.selectedItemsMap.set(t,!0)))}),this.requestUpdate("selected",s)}get focusInItem(){var e;return(e=this.rovingTabindexController)==null?void 0:e.focusInElement}get controlsRovingTabindex(){return!0}get childItems(){return this.cachedChildItems||(this.cachedChildItems=this.updateCachedMenuItems()),this.cachedChildItems}updateCachedMenuItems(){var t;if(!this.menuSlot)return[];const e=[],s=this.menuSlot.assignedElements({flatten:!0});for(const[i,n]of s.entries()){if(this.childItemSet.has(n)){e.push(n);continue}const d=n.localName==="slot"?n.assignedElements({flatten:!0}):[...n.querySelectorAll(":scope > *")];s.splice(i,1,n,...d)}return this.cachedChildItems=[...e],(t=this.rovingTabindexController)==null||t.clearElementCache(),this.cachedChildItems}get childRole(){if(this.resolvedRole==="listbox")return"option";switch(this.resolvedSelects){case"single":return"menuitemradio";case"multiple":return"menuitemcheckbox";default:return"menuitem"}}get ownRole(){return"menu"}onFocusableItemAddedOrUpdated(e){e.menuCascade.set(this,{hadFocusRoot:!!e.item.menuData.focusRoot,ancestorWithSelects:e.currentAncestorWithSelects}),this.selects&&(e.currentAncestorWithSelects=this),e.item.menuData.focusRoot=e.item.menuData.focusRoot||this}onSelectableItemAddedOrUpdated(e){var i,n;if(!e.menuCascade.get(this))return;if(e.item.menuData.parentMenu=e.item.menuData.parentMenu||this,this.addChildItem(e.item),this.selects==="inherit"){this.resolvedSelects="inherit";const l=(i=e.currentAncestorWithSelects)==null?void 0:i.ignore;this.resolvedRole=l?"none":((n=e.currentAncestorWithSelects)==null?void 0:n.getAttribute("role"))||this.getAttribute("role")||void 0}else this.selects?(this.resolvedRole=this.ignore?"none":this.getAttribute("role")||void 0,this.resolvedSelects=this.selects):(this.resolvedRole=this.ignore?"none":this.getAttribute("role")||void 0,this.resolvedSelects=this.resolvedRole==="none"?"ignore":"none");if(this.resolvedRole==="none")return;const t=this.resolvedSelects==="single"||this.resolvedSelects==="multiple";e.item.menuData.cleanupSteps.push(l=>this.removeChildItem(l)),(t||!this.selects&&this.resolvedSelects!=="ignore")&&!e.item.menuData.selectionRoot&&(e.item.setRole(this.childRole),e.item.menuData.selectionRoot=e.item.menuData.selectionRoot||this,e.item.selected&&(this.selectedItemsMap.set(e.item,!0),this.selectedItems=[...this.selectedItems,e.item],this._selected=[...this.selected,e.item.value],this.value=this.selected.join(this.valueSeparator)))}addChildItem(e){this.childItemSet.add(e),this.handleItemsChanged()}async removeChildItem(e){(e.focused||e.hasAttribute("focused")||e.active)&&(this._updateFocus=this.getNeighboringFocusableElement(e)),this.childItemSet.delete(e),this.cachedChildItems=void 0}focusOnFirstSelectedItem({preventScroll:e}={}){var t;if(!this.rovingTabindexController)return;const s=this.selectedItems.find(i=>this.isFocusableElement(i));if(!s){this.focus({preventScroll:e});return}s&&!e&&s.scrollIntoView({block:"nearest"}),(t=this.rovingTabindexController)==null||t.focusOnItem(s)}focus({preventScroll:e}={}){if(this.rovingTabindexController){if(!this.childItems.length||this.childItems.every(s=>s.disabled))return;if(this.childItems.some(s=>s.menuData.focusRoot!==this)){super.focus({preventScroll:e});return}this.rovingTabindexController.focus({preventScroll:e})}}handleFocusout(){var e;this.matches(":focus-within")||(e=this.rovingTabindexController)==null||e.reset()}handleClick(e){if(this.pointerUpTarget===e.target){this.pointerUpTarget=null;return}this.handlePointerBasedSelection(e)}handlePointerup(e){this.shouldSupportDragAndSelect&&(this.pointerUpTarget=e.target,this.handlePointerBasedSelection(e))}async handlePointerBasedSelection(e){var i,n;if(e instanceof MouseEvent&&e.button!==0)return;const t=e.composedPath().find(l=>l instanceof Element?l.getAttribute("role")===this.childRole:!1);if(e.defaultPrevented){const l=this.childItems.indexOf(t);((i=t==null?void 0:t.menuData)==null?void 0:i.focusRoot)===this&&l>-1&&(this.focusedItemIndex=l);return}if(t!=null&&t.href&&t.href.length){this.dispatchEvent(new Event("change",{bubbles:!0,composed:!0}));return}else if(((n=t==null?void 0:t.menuData)==null?void 0:n.selectionRoot)===this&&this.childItems.length){if(e.preventDefault(),t.hasSubmenu||t.open)return;this.selectOrToggleItem(t)}else return;this.prepareToCleanUp()}handleDescendentOverlayOpened(e){const s=e.composedPath()[0];s.overlayElement&&this.descendentOverlays.set(s.overlayElement,s.overlayElement)}handleDescendentOverlayClosed(e){const s=e.composedPath()[0];s.overlayElement&&this.descendentOverlays.delete(s.overlayElement)}getNeighboringFocusableElement(e,s=!1){var d;const t=s?-1:1,i=((d=this.rovingTabindexController)==null?void 0:d.elements)||[],n=e?i.indexOf(e):-1;let l=Math.min(Math.max(0,n+t),i.length-1);for(;!this.isFocusableElement(i[l])&&0<l&&l<i.length-1;)l+=t;return this.isFocusableElement(i[l])?i[l]:e||i[0]}async selectOrToggleItem(e){var a;const s=this.resolvedSelects,t=new Map(this.selectedItemsMap),i=this.selected.slice(),n=this.selectedItems.slice(),l=this.value;if(e.menuData.selectionRoot!==this)return;if(s==="multiple"){this.selectedItemsMap.has(e)?this.selectedItemsMap.delete(e):this.selectedItemsMap.set(e,!0);const r=[],m=[];this.childItemSet.forEach(h=>{h.menuData.selectionRoot===this&&this.selectedItemsMap.has(h)&&(r.push(h.value),m.push(h))}),this._selected=r,this.selectedItems=m,this.value=this.selected.join(this.valueSeparator)}else this.selectedItemsMap.clear(),this.selectedItemsMap.set(e,!0),this.value=e.value,this._selected=[e.value],this.selectedItems=[e];if(!this.dispatchEvent(new Event("change",{cancelable:!0,bubbles:!0,composed:!0}))){this._selected=i,this.selectedItems=n,this.selectedItemsMap=t,this.value=l;return}if(s==="single"){for(const r of t.keys())r!==e&&(r.selected=!1);e.selected=!0}else s==="multiple"?e.selected=!e.selected:!e.hasSubmenu&&((a=e==null?void 0:e.menuData)==null?void 0:a.focusRoot)===this&&this.dispatchEvent(new Event("close",{bubbles:!0}))}navigateBetweenRelatedMenus(e){const{key:s,root:t}=e,i=this.isLTR&&s==="ArrowRight"||!this.isLTR&&s==="ArrowLeft",n=this.isLTR&&s==="ArrowLeft"||!this.isLTR&&s==="ArrowRight"||s==="Escape",l=t;i?l!=null&&l.hasSubmenu&&(e.stopPropagation(),l.openOverlay(!0)):n&&this.isSubmenu&&(e.stopPropagation(),this.dispatchEvent(new Event("close",{bubbles:!0})),this.updateSelectedItemIndex())}handleKeydown(e){var d;if(e.defaultPrevented||!this.rovingTabindexController)return;const{key:s,root:t,shiftKey:i,target:n}=e,l=["Enter"," "].includes(s);if(i&&n!==this&&this.hasAttribute("tabindex")){this.removeAttribute("tabindex");const a=r=>{!r.shiftKey&&!this.hasAttribute("tabindex")&&(document.removeEventListener("keyup",a),this.removeEventListener("focusout",a))};document.addEventListener("keyup",a),this.addEventListener("focusout",a)}if(s==="Tab"){this.closeDescendentOverlays();return}if(l&&(t!=null&&t.hasSubmenu)&&!t.open){e.preventDefault(),t.openOverlay(!0);return}if(s===" "||s==="Enter"){e.preventDefault(),(d=t==null?void 0:t.focusElement)==null||d.click(),t&&this.selectOrToggleItem(t);return}this.navigateBetweenRelatedMenus(e)}prepareToCleanUp(){document.addEventListener("focusout",()=>{requestAnimationFrame(()=>{const e=this.focusInItem;e&&(e.focused=!1)})},{once:!0})}updateSelectedItemIndex(){let e=0;const s=new Map,t=[],i=[];let n=this.childItems.length;for(;n;){n-=1;const l=this.childItems[n];l.menuData.selectionRoot===this&&((l.selected||!this._hasUpdatedSelectedItemIndex&&this.selected.includes(l.value))&&(e=n,s.set(l,!0),t.unshift(l.value),i.unshift(l)),n!==e&&(l.focused=!1))}this.selectedItemsMap=s,this._selected=t,this.selectedItems=i,this.value=this.selected.join(this.valueSeparator),this.focusedItemIndex=e,this.focusInItemIndex=e}handleItemsChanged(){this.cachedChildItems=void 0,this._willUpdateItems||(this._willUpdateItems=!0,this.cacheUpdated=this.updateCache())}async updateCache(){this.hasUpdated?await new Promise(e=>requestAnimationFrame(()=>e(!0))):await Promise.all([new Promise(e=>requestAnimationFrame(()=>e(!0))),this.updateComplete]),this.cachedChildItems===void 0&&(this.updateSelectedItemIndex(),this.updateItemFocus()),this._willUpdateItems=!1}updateItemFocus(){var e;(e=this.focusInItem)==null||e.setAttribute("tabindex","0"),this.childItems.length!=0}closeDescendentOverlays(){this.descendentOverlays.forEach(e=>{e.open=!1}),this.descendentOverlays=new Map}handleSlotchange({target:e}){var t;const s=e.assignedElements({flatten:!0});this.childItems.length!==s.length&&s.forEach(i=>{typeof i.triggerUpdate!="undefined"?i.triggerUpdate():typeof i.childItems!="undefined"&&i.childItems.forEach(n=>{n.triggerUpdate()})}),this._updateFocus&&((t=this.rovingTabindexController)==null||t.focusOnItem(this._updateFocus),this._updateFocus=void 0)}renderMenuItemSlot(){return b`
            <slot
                @sp-menu-submenu-opened=${this.handleDescendentOverlayOpened}
                @sp-menu-submenu-closed=${this.handleDescendentOverlayClosed}
                @slotchange=${this.handleSlotchange}
            ></slot>
        `}render(){return this.renderMenuItemSlot()}firstUpdated(e){super.firstUpdated(e);const s=[new Promise(t=>requestAnimationFrame(()=>t(!0)))];[...this.children].forEach(t=>{t.localName==="sp-menu-item"&&s.push(t.updateComplete)}),this.childItemsUpdated=Promise.all(s)}updated(e){super.updated(e),e.has("selects")&&this.hasUpdated&&this.selectsChanged(),e.has("label")&&(this.label||typeof e.get("label")!="undefined")&&(this.label?this.setAttribute("aria-label",this.label):this.removeAttribute("aria-label"))}selectsChanged(){const e=[new Promise(s=>requestAnimationFrame(()=>s(!0)))];this.childItemSet.forEach(s=>{e.push(s.triggerUpdate())}),this.childItemsUpdated=Promise.all(e)}connectedCallback(){super.connectedCallback(),!this.hasAttribute("role")&&!this.ignore&&this.setAttribute("role",this.ownRole),this.updateComplete.then(()=>this.updateItemFocus())}isFocusableElement(e){return e?!e.disabled:!1}disconnectedCallback(){this.cachedChildItems=void 0,this.selectedItems=[],this.selectedItemsMap.clear(),this.childItemSet.clear(),this.descendentOverlays=new Map,super.disconnectedCallback()}async getUpdateComplete(){const e=await super.getUpdateComplete();return await this.childItemsUpdated,await this.cacheUpdated,e}}Menu.shadowRootOptions={...f.shadowRootOptions,delegatesFocus:!0},o([u({type:String,reflect:!0})],Menu.prototype,"label",2),o([u({type:Boolean,reflect:!0})],Menu.prototype,"ignore",2),o([u({type:String,reflect:!0})],Menu.prototype,"selects",2),o([u({type:String})],Menu.prototype,"value",2),o([u({type:String,attribute:"value-separator"})],Menu.prototype,"valueSeparator",2),o([u({attribute:!1})],Menu.prototype,"selected",1),o([u({attribute:!1})],Menu.prototype,"selectedItems",2),o([E("slot:not([name])")],Menu.prototype,"menuSlot",2);
//# sourceMappingURL=Menu.js.map
