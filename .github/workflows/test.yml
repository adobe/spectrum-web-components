name: Performance check

on: pull_request

jobs:
    compare:
        name: Compare performance to latest release
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: main

            - uses: actions/checkout@v2

            - name: Setup Node 14
              uses: actions/setup-node@v2
              with:
                  node-version: '14'
                  cache: 'yarn'
                  registry-url: 'https://registry.npmjs.org'

            - name: Install dependencies
              run: yarn --frozen-lockfile

            - name: Tachometer the changed packages
              run: yarn test:changed

            - uses: actions/github-script@v4
              with:
                  script: |
                      const buildTachometerComment = require('./tasks/build-tachometer-comment.cjs').buildTachometerComment;
                      const body = buildTachometerComment();
                      github.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                      }).then(({data}) => {
                        const priorComment = data.find(comment => comment.body.startsWith('# Tachometer results for changed packages'));
                        if (priorComment) {
                          github.issues.updateComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            comment_id: priorComment.id,
                            body
                          });
                        } else {
                          github.issues.createComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: context.issue.number,
                            body
                          });
                        }
                      });
