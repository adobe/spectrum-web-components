name: Review URLs and Smoke Tests

on:
    workflow_run:
        workflows: ['Preview Documentation (Azure)']
        types:
            - completed

jobs:
    playwright-smoke-tests:
        timeout-minutes: 60
        runs-on: ubuntu-latest
        if: github.event.workflow_run.conclusion == 'success'
        steps:
            - name: Checkout PR branch
              uses: actions/checkout@v4

            - name: Setup Job and Install Dependencies
              uses: ./.github/actions/setup-job

            - name: Install Playwright Browsers
              run: yarn playwright install --with-deps

            - name: Get Azure deployment URL
              id: get_url
              uses: actions/github-script@v7
              with:
                  script: |
                      // Get the workflow run that triggered this
                      const workflowRun = context.payload.workflow_run;

                      // Get the jobs for that workflow run
                      const jobs = await github.rest.actions.listJobsForWorkflowRun({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          run_id: workflowRun.id
                      });

                      // Find the build_and_deploy_job
                      const deployJob = jobs.data.jobs.find(job => job.name === 'Build and Deploy Job');

                      if (!deployJob) {
                          throw new Error('Could not find Build and Deploy Job');
                      }

                      // Get the workflow run details to access outputs
                      const workflowRunDetails = await github.rest.actions.getWorkflowRun({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          run_id: workflowRun.id
                      });

                      // For now, we'll extract the URL from the PR comments as a fallback
                      // since workflow outputs aren't easily accessible across workflows
                      const prNumber = workflowRun.pull_requests[0]?.number;
                      if (prNumber) {
                          const comments = await github.rest.issues.listComments({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: prNumber
                          });
                          
                          const deploymentComment = comments.data.find(comment => 
                              comment.body.includes('## Branch preview')
                          );
                          
                          if (deploymentComment) {
                              // Extract URL from the comment
                              const urlMatch = deploymentComment.body.match(/\[Documentation Site\]\((https:\/\/[^)]+)\)/);
                              if (urlMatch) {
                                  core.setOutput('doc_url', urlMatch[1]);
                                  return;
                              }
                          }
                      }

                      throw new Error('Could not extract deployment URL');

            - name: Run Playwright tests
              run: yarn playwright test projects/documentation/e2e/published.spec.ts
              env:
                  DOC_PREVIEW_URL: ${{ steps.get_url.outputs.doc_url }}
                  NODE_ENV: CI

            - name: Upload Playwright Report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30
