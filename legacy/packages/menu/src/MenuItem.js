"use strict";var c=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var r=(a,i,e,t)=>{for(var n=t>1?void 0:t?p(i,e):i,s=a.length-1,d;s>=0;s--)(d=a[s])&&(n=(t?d(i,e,n):d(n))||n);return t&&n&&c(i,e,n),n};import{html as l,nothing as h}from"@spectrum-web-components/base";import{ObserveSlotPresence as m,ObserveSlotText as v,randomID as b}from"@spectrum-web-components/shared";import{property as o,query as u}from"@spectrum-web-components/base/src/decorators.js";import"@spectrum-web-components/icons-ui/icons/sp-icon-checkmark100.js";import{LikeAnchor as f}from"@spectrum-web-components/shared/src/like-anchor.js";import{Focusable as E}from"@spectrum-web-components/shared/src/focusable.js";import"@spectrum-web-components/icons-ui/icons/sp-icon-chevron100.js";import y from"@spectrum-web-components/icon/src/spectrum-icon-chevron.css.js";import{DependencyManagerController as g}from"@spectrum-web-components/reactive-controllers/src/DependencyManger.js";import S from"./menu-item.css.js";import C from"@spectrum-web-components/icon/src/spectrum-icon-checkmark.css.js";import{MutationController as M}from"@lit-labs/observers/mutation-controller.js";import{SlottableRequestEvent as L}from"@spectrum-web-components/overlay/src/slottable-request-event.js";const k=100;export class MenuItemAddedOrUpdatedEvent extends Event{constructor(e){super("sp-menu-item-added-or-updated",{bubbles:!0,composed:!0});this.menuCascade=new WeakMap;this.clear(e)}clear(e){this._item=e,this.currentAncestorWithSelects=void 0,e.menuData={cleanupSteps:[],focusRoot:void 0,selectionRoot:void 0,parentMenu:void 0},this.menuCascade=new WeakMap}get item(){return this._item}}export class MenuItemKeydownEvent extends KeyboardEvent{constructor({root:i,event:e}){super("sp-menu-item-keydown",{bubbles:!0,composed:!0}),this.root=i,this._event=e}get altKey(){var i;return((i=this._event)==null?void 0:i.altKey)||!1}get code(){var i;return((i=this._event)==null?void 0:i.code)||""}get ctrlKey(){var i;return((i=this._event)==null?void 0:i.ctrlKey)||!1}get isComposing(){var i;return((i=this._event)==null?void 0:i.isComposing)||!1}get key(){var i;return((i=this._event)==null?void 0:i.key)||""}get location(){var i;return((i=this._event)==null?void 0:i.location)||0}get metaKey(){var i;return((i=this._event)==null?void 0:i.metaKey)||!1}get repeat(){var i;return((i=this._event)==null?void 0:i.repeat)||!1}get shiftKey(){var i;return((i=this._event)==null?void 0:i.shiftKey)||!1}}export class MenuItem extends f(v(m(E,'[slot="icon"]'))){constructor(){super();this.active=!1;this.dependencyManager=new g(this);this.focused=!1;this.selected=!1;this._value="";this.hasSubmenu=!1;this.noWrap=!1;this.open=!1;this._openedViaKeyboard=!1;this._closedViaPointer=!1;this.handleSlottableRequest=e=>{var t;(t=this.submenuElement)==null||t.dispatchEvent(new L(e.name,e.data))};this.proxyFocus=()=>{this.focus()};this.handleKeydown=e=>{const{target:t,key:n}=e,s=this.hasSubmenu&&!this.open&&[" ","Enter"].includes(n);t===this&&((["ArrowLeft","ArrowRight","Escape"].includes(n)||s)&&e.preventDefault(),this.dispatchEvent(new MenuItemKeydownEvent({root:this,event:e})))};this.handleBeforetoggle=e=>{e.newState==="closed"&&(this.open=!0,this.overlayElement.manuallyKeepOpen(),this.overlayElement.removeEventListener("beforetoggle",this.handleBeforetoggle))};this.recentlyLeftChild=!1;this.willDispatchUpdate=!1;this.menuData={focusRoot:void 0,parentMenu:void 0,selectionRoot:void 0,cleanupSteps:[]};this.addEventListener("click",this.handleClickCapture,{capture:!0}),this.addEventListener("focus",this.handleFocus),this.addEventListener("blur",this.handleBlur),new M(this,{config:{characterData:!0,childList:!0,subtree:!0,attributeFilter:["src"]},callback:e=>{e.every(n=>n.target.slot==="submenu")||this.breakItemChildrenCache()}})}static get styles(){return[S,C,y]}get value(){return this._value||this.itemText}set value(e){e!==this._value&&(this._value=e||"",this._value?this.setAttribute("value",this._value):this.removeAttribute("value"))}get itemText(){return this.itemChildren.content.reduce((e,t)=>e+(t.textContent||"").trim(),"")}get focusElement(){return this}get hasIcon(){return this.slotContentIsPresent}get itemChildren(){if(!this.iconSlot||!this.contentSlot)return{icon:[],content:[]};if(this._itemChildren)return this._itemChildren;const e=this.iconSlot.assignedElements().map(n=>{const s=n.cloneNode(!0);return s.removeAttribute("slot"),s.classList.toggle("icon"),s}),t=this.contentSlot.assignedNodes().map(n=>n.cloneNode(!0));return this._itemChildren={icon:e,content:t},this._itemChildren}handleClickCapture(e){if(this.disabled)return e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),!1;this.shouldProxyClick()}shouldProxyClick(){let e=!1;return this.anchorElement&&(this.anchorElement.click(),e=!0),e}breakItemChildrenCache(){this._itemChildren=void 0,this.triggerUpdate()}renderSubmenu(){const e=l`
            <slot
                name="submenu"
                @slotchange=${this.manageSubmenu}
                @sp-menu-item-added-or-updated=${{handleEvent:t=>{t.clear(t.item)},capture:!0}}
                @focusin=${t=>t.stopPropagation()}
            ></slot>
        `;return this.hasSubmenu?(this.dependencyManager.add("sp-overlay"),this.dependencyManager.add("sp-popover"),import("@spectrum-web-components/overlay/sp-overlay.js"),import("@spectrum-web-components/popover/sp-popover.js"),l`
            <sp-overlay
                receives-focus="false"
                .triggerElement=${this}
                ?disabled=${!this.hasSubmenu}
                ?open=${this.hasSubmenu&&this.open&&this.dependencyManager.loaded}
                .placement=${this.isLTR?"right-start":"left-start"}
                receives-focus="false"
                .offset=${[-10,-5]}
                .type=${"auto"}
                @close=${t=>t.stopPropagation()}
                @slottable-request=${this.handleSlottableRequest}
            >
                <sp-popover
                    @change=${t=>{this.handleSubmenuChange(t),this.open=!1}}
                    @pointerenter=${this.handleSubmenuPointerenter}
                    @pointerleave=${this.handleSubmenuPointerleave}
                    @sp-menu-item-added-or-updated=${t=>t.stopPropagation()}
                >
                    ${e}
                </sp-popover>
            </sp-overlay>
            <sp-icon-chevron100
                class="spectrum-UIIcon-ChevronRight100 chevron icon"
            ></sp-icon-chevron100>
        `):e}render(){return l`
            ${this.selected?l`
                      <sp-icon-checkmark100
                          id="selected"
                          class="spectrum-UIIcon-Checkmark100 
                            icon 
                            checkmark
                            ${this.hasIcon?"checkmark--withAdjacentIcon":""}"
                      ></sp-icon-checkmark100>
                  `:h}
            <slot name="icon"></slot>
            <div id="label">
                <slot id="slot"></slot>
            </div>
            <slot name="description"></slot>
            <slot name="value"></slot>
            ${this.href&&this.href.length>0?super.renderAnchor({id:"button",ariaHidden:!0,className:"button anchor hidden"}):h}
            ${this.renderSubmenu()}
        `}manageSubmenu(e){this.submenuElement=e.target.assignedElements({flatten:!0})[0],this.hasSubmenu=!!this.submenuElement,this.hasSubmenu&&this.setAttribute("aria-haspopup","true")}handlePointerdown(e){e.target===this&&this.hasSubmenu&&this.open&&(this.addEventListener("focus",this.handleSubmenuFocus,{once:!0}),this.overlayElement.addEventListener("beforetoggle",this.handleBeforetoggle))}firstUpdated(e){super.firstUpdated(e),this.setAttribute("tabindex","-1"),this.addEventListener("keydown",this.handleKeydown),this.addEventListener("mouseover",this.handleMouseover),this.addEventListener("pointerdown",this.handlePointerdown),this.addEventListener("pointerenter",this.closeOverlaysForRoot),this.hasAttribute("id")||(this.id=`sp-menu-item-${b()}`)}handleMouseover(e){e.target===this&&(this.focus(),this.focused=!1)}closeOverlaysForRoot(){var e;this.open||(e=this.menuData.parentMenu)==null||e.closeDescendentOverlays()}handleFocus(e){const{target:t}=e;t===this&&(this.focused=!0)}handleBlur(e){const{target:t}=e;t===this&&(this.focused=!1)}handleSubmenuClick(e){e.composedPath().includes(this.overlayElement)||this.openOverlay(!0)}handleSubmenuFocus(){requestAnimationFrame(()=>{this.overlayElement.open=this.open,this.focused=!1})}handlePointerenter(){if(this.leaveTimeout){clearTimeout(this.leaveTimeout),delete this.leaveTimeout,this.recentlyLeftChild=!1;return}this.focus(),this.openOverlay()}handlePointerleave(){this._closedViaPointer=!0,this.open&&!this.recentlyLeftChild&&(this.leaveTimeout=setTimeout(()=>{delete this.leaveTimeout,this.open=!1},k))}handleSubmenuChange(e){var t;e.stopPropagation(),(t=this.menuData.selectionRoot)==null||t.selectOrToggleItem(this)}handleSubmenuPointerenter(){this.recentlyLeftChild=!0}async handleSubmenuPointerleave(){this.recentlyLeftChild=!1}handleSubmenuOpen(e){var n;const t=e.composedPath().find(s=>s!==this.overlayElement&&s.localName==="sp-overlay");this._openedViaKeyboard&&((n=this.submenuElement)==null||n.focus()),this.overlayElement.parentOverlayToForceClose=t}cleanup(){this._closedViaPointer=!1,this.setAttribute("aria-expanded","false"),this.open=!1,this.active=!1}async openOverlay(e=!1){!this.hasSubmenu||this.open||this.disabled||(this.open=!0,this.active=!0,this.setAttribute("aria-expanded","true"),this._openedViaKeyboard=e,this.addEventListener("sp-closed",this.cleanup,{once:!0}))}updateAriaSelected(){const e=this.getAttribute("role");e==="option"?this.setAttribute("aria-selected",this.selected?"true":"false"):(e==="menuitemcheckbox"||e==="menuitemradio")&&this.setAttribute("aria-checked",this.selected?"true":"false")}setRole(e){this.setAttribute("role",e),this.updateAriaSelected()}willUpdate(e){super.updated(e),e.has("open")&&!this.open&&this.hasSubmenu&&!this._closedViaPointer&&this.matches(":focus-within")&&this.focus()}updated(e){var t,n;if(super.updated(e),e.has("label")&&(this.label||typeof e.get("label")!="undefined")&&this.setAttribute("aria-label",this.label||""),e.has("active")&&(this.active||typeof e.get("active")!="undefined")&&this.active&&((t=this.menuData.selectionRoot)==null||t.closeDescendentOverlays()),this.anchorElement&&(this.anchorElement.addEventListener("focus",this.proxyFocus),this.anchorElement.tabIndex=-1),e.has("selected")&&this.updateAriaSelected(),e.has("hasSubmenu")&&(this.hasSubmenu||typeof e.get("hasSubmenu")!="undefined"))if(this.hasSubmenu){this.abortControllerSubmenu=new AbortController;const s={signal:this.abortControllerSubmenu.signal};this.addEventListener("click",this.handleSubmenuClick,s),this.addEventListener("pointerenter",this.handlePointerenter,s),this.addEventListener("pointerleave",this.handlePointerleave,s),this.addEventListener("sp-opened",this.handleSubmenuOpen,s)}else(n=this.abortControllerSubmenu)==null||n.abort()}connectedCallback(){super.connectedCallback(),this.triggerUpdate()}disconnectedCallback(){this.menuData.cleanupSteps.forEach(e=>e(this)),this.menuData={focusRoot:void 0,parentMenu:void 0,selectionRoot:void 0,cleanupSteps:[]},super.disconnectedCallback()}async triggerUpdate(){this.willDispatchUpdate||(this.willDispatchUpdate=!0,await new Promise(e=>requestAnimationFrame(e)),this.dispatchUpdate())}focus(){super.focus(),this.dispatchEvent(new FocusEvent("focus"))}blur(){this.dispatchEvent(new FocusEvent("blur")),super.blur()}dispatchUpdate(){this.isConnected&&(this.dispatchEvent(new MenuItemAddedOrUpdatedEvent(this)),this.willDispatchUpdate=!1)}}r([o({type:Boolean,reflect:!0})],MenuItem.prototype,"active",2),r([o({type:Boolean,reflect:!0})],MenuItem.prototype,"focused",2),r([o({type:Boolean,reflect:!0})],MenuItem.prototype,"selected",2),r([o({type:String})],MenuItem.prototype,"value",1),r([o({type:Boolean,reflect:!0,attribute:"has-submenu"})],MenuItem.prototype,"hasSubmenu",2),r([u("slot:not([name])")],MenuItem.prototype,"contentSlot",2),r([u('slot[name="icon"]')],MenuItem.prototype,"iconSlot",2),r([o({type:Boolean,reflect:!0,attribute:"no-wrap",hasChanged(){return!1}})],MenuItem.prototype,"noWrap",2),r([u(".anchor")],MenuItem.prototype,"anchorElement",2),r([u("sp-overlay")],MenuItem.prototype,"overlayElement",2),r([o({type:Boolean,reflect:!0})],MenuItem.prototype,"open",2);
//# sourceMappingURL=MenuItem.js.map
